# Используем более легковесный базовый образ с Python
FROM python:3.9-slim-buster AS base

# Устанавливаем рабочую директорию
WORKDIR /app

# Создаем непривилегированного пользователя и группу
# Используем --system для системного пользователя без домашней директории
# Используем --no-create-home, т.к. домашняя директория не нужна
RUN groupadd --system appgroup && \
    useradd --system --no-create-home --gid appgroup appuser

# Копируем необходимые файлы приложения
# Копируем сначала config.txt, затем скрипт.
# Если config.txt меняется реже скрипта, это может улучшить кеширование.
COPY config.txt .
COPY search_complex.py .

# Делаем скрипт исполняемым (хотя его можно запускать и через python3)
RUN chmod +x search_complex.py

# Меняем владельца файлов на непривилегированного пользователя
# Это важно для безопасности, чтобы пользователь appuser мог работать с файлами
RUN chown -R appuser:appgroup /app

# Переключаемся на непривилегированного пользователя
USER appuser

# Указываем команду по умолчанию для запуска контейнера
# Запускаем скрипт с параметрами по умолчанию (файл config.txt, ищем слово 'path')
# Используем exec form (массив JSON) для CMD - это лучшая практика
CMD ["./search_complex.py", "config.txt", "path"]
